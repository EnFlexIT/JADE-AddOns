PACKAGE_DIR:=$(shell pwd)
export PACKAGE_DIR

ifeq (Rules.mk,$(wildcard Rules.mk))
include Rules.mk
endif

subdirs=src

ZIPNAME=BEFipaMessageAddOn.zip
add_files=CHANGES COPYRIGHT LICENSE README Makefile Rules.mk doc/index.html
LIBBENAME=BEFipaMessage.jar
DIRNAME=jade/add-ons/BEFipaMessage
LIBEXAMPLES=BEExamples.jar
FILENAMES = 	sonera/fipa/acl/BitEffACLCodec.java \
		examples/DummyDecoder.java \
		examples/DummyEncoder.java

all:
	test -d classes || mkdir classes
	for i in $(subdirs); do (cd $$i; make $@); done

doc: dummy
	(cd src/sonera/fipa && make doc)
	mv src/sonera/fipa/api doc
dummy:
#
# Deletes .class files
#
clean:
	for i in $(subdirs); do (cd $$i; make $@); done
	rm -fr classes

#
# Deletes all generated files
#
distclean: clean
	rm -fr lib
	rm -fr doc/api	
	echo $(BATCH_BE)
	rm -f $(BATCH_BE) $(BATCH_BE_CLEAN) $(BATCH_BE_DIST) $(BATCH_BE_LIB)

be: all

#
# Creates distribution package (*.java + other necessary files)
#
dist: belib
	rm -f $(ZIPNAME)
	(cd src && make clean)
	(cd ../../.. && zip -r $(DIRNAME)/$(ZIPNAME) $(DIRNAME)/src )
	(cd ../../.. && zip -r $(DIRNAME)/$(ZIPNAME) $(DIRNAME)/lib )
	(cd ../../.. && for i in $(add_files); do (zip $(DIRNAME)/$(ZIPNAME) $(DIRNAME)/$$i); done)

#
# Creates BEFipaMessage.jar
#
belib:
	test -d lib || mkdir lib
	make all
	(cd classes && $(AR) $(ARFLAGS) ../lib/$(LIBBENAME) sonera)
	(cd classes && $(AR) $(ARFLAGS) ../lib/$(LIBEXAMPLES) *.class)

#
# Creates batch files equivalent to make rules
#
#FILES=$(shell cd src; find ./sonera -name *.java; find ./examples -name *.java)
batch:
	@rm -f $(BATCH_BE) $(BATCH_BE_CLEAN) $(BATCH_BE_DIST) $(BATCH_BE_LIB)
	@echo "Generating $(BATCH_BE)..."
	@echo '@REM ===============================================================' > $(BATCH_BE)
	@echo '@REM =   Generated by JADE Makefile. DO NOT EDIT                   =' >> $(BATCH_BE)
	@echo '@REM ===============================================================' >> $(BATCH_BE)
	@echo >> $(BATCH_BE)
	@echo 'mkdir classes' >> $(BATCH_BE)
	@echo 'mkdir lib' >> $(BATCH_BE)
	@echo 'cd src' >> $(BATCH_BE)
	@echo >> $(BATCH_BE)
	@echo '$(JAVAC) -classpath ..\$(subst /,\,$(subst $(ROOTDIR),..,$(LIBJADE)));..\classes\ -deprecation -O -d ..\classes -sourcepath . $(subst /,\,$(FILENAMES))' >> $(BATCH_BE)
	@echo >> $(BATCH_BE)
	@echo 'cd ..' >> $(BATCH_BE)
	@echo "Generating $(BATCH_BE_LIB)..."
	@echo '@REM ===============================================================' > $(BATCH_BE_LIB)
	@echo '@REM =   Generated by JADE Makefile. DO NOT EDIT                   =' >> $(BATCH_BE_LIB)
	@echo '@REM ===============================================================' >> $(BATCH_BE_LIB)
	@echo >> $(BATCH_BE_LIB)
	@echo 'cd .\classes'>> $(BATCH_BE_LIB)
	@echo >> $(BATCH_BE_LIB)
	@echo 'rmdir /S /Q ..\lib\$(LIBEXAMPLES)' >> $(BATCH_BE_LIB) # For Win 95/98
	@echo 'rmdir /S /Q ..\lib\$(LIBBENAME)' >> $(BATCH_BE_LIB) # For Win 95/98
	@echo 'deltree /Y ..\lib\$(LIBEXAMPLES)' >> $(BATCH_BE_LIB)  # For Win 95/98
	@echo 'deltree /Y ..\lib\$(LIBBENAME)' >> $(BATCH_BE_LIB)  # For Win 95/98
	@echo >> $(BATCH_BE_LIB)
	@echo '$(AR) $(ARFLAGS) ..\lib\$(LIBBENAME) sonera' >> $(BATCH_BE_LIB)
	@echo '$(AR) $(ARFLAGS) ..\lib\$(LIBEXAMPLES) *.class' >> $(BATCH_BE_LIB)
	@echo 'rmdir /S /Q sonera' >> $(BATCH_BE_LIB) # For Win NT 4
	@echo 'deltree /Y sonera' >> $(BATCH_BE_LIB)  # For Win 95/98
	@echo 'del *.class' >> $(BATCH_BE_LIB)  # For Win 95/98	
	@echo >> $(BATCH_BE_LIB)
	@echo 'cd ..' >> $(BATCH_BE_LIB)
	@echo "Generating $(BATCH_BE_CLEAN)..." 
	@echo '@REM ===============================================================' > $(BATCH_BE_CLEAN)
	@echo '@REM =   Generated by JADE Makefile. DO NOT EDIT                   =' >> $(BATCH_BE_CLEAN)
	@echo '@REM ===============================================================' >> $(BATCH_BE_CLEAN)
	@echo >> $(BATCH_BE_CLEAN)
	@echo 'rmdir /S /Q .\classes' >> $(BATCH_BE_CLEAN) # For Win NT 4
	@echo 'deltree /Y .\classes' >> $(BATCH_BE_CLEAN) # For Win 95/98
	@echo 'del .\lib\$(LIBBENAME)' >> $(BATCH_BE_CLEAN)
	@echo 'del .\lib\$(LIBEXAMPLES)' >> $(BATCH_BE_CLEAN)
	@echo "Generating $(BATCH_BE_DIST)..."
	@echo '@REM ===============================================================' > $(BATCH_BE_DIST)
	@echo '@REM =   Generated by JADE Makefile. DO NOT EDIT                   =' >> $(BATCH_BE_DIST)
	@echo '@REM ===============================================================' >> $(BATCH_BE_DIST)
	@echo >> $(BATCH_BE_DIST)
	@echo 'call .\$(BATCH_BE)' >> $(BATCH_BE_DIST)
	@echo 'call .\$(BATCH_BE_LIB)' >> $(BATCH_BE_DIST)
	@echo 'cd doc' >> $(BATCH_BE)
	@echo 'mkdir api' >> $(BATCH_BE)
	@echo 'cd ..' >> $(BATCH_BE)
	@echo 'javadoc -sourcepath src -d .\doc\api -author -windowtitle "BitEfficient ACLCodec" sonera.fipa.acl sonera.fipa.util' >> $(BATCH_BE_DIST)
	@echo 'cd ..\..' >> $(BATCH_BE_DIST)
	@echo '$(ZIP) $(ZIPFLAGS) $(ZIPNAME) add-ons/BEFipaMessage' >> $(BATCH_BE_DIST)
#	@echo 'cd jade' >> $(BATCH_BE_DIST)
#	@echo 'cd add-ons' >> $(BATCH_BE_DIST)
#	@echo 'cd BEFipaMessage' >> $(BATCH_BE_DIST)
