# Makefile for JADE project

VERSION    = 2.4
PACKAGE    = XML-ACL

ZIP = jar
ZIPFLAGS = cMvf
ZIPEXT = zip
AR = jar
ARFLAGS = cf

ROOTDIR = $(shell pwd)
ROOTNAME = $(shell basename $(ROOTDIR))
DOCDIR  = $(ROOTDIR)/../doc
SRCDIR  = $(ROOTDIR)/src
CLSDIR  = $(ROOTDIR)/classes
LIBDIR  = $(ROOTDIR)/lib
JADESRCDIR=$(ROOTDIR)/../../src
JADECLSDIR  = $(ROOTDIR)/../../classes
JADELIBDIR  = $(ROOTDIR)/../../lib
LIBJADE = $(JADELIBDIR)/jade.jar
LIBBASE64 = $(JADELIBDIR)/Base64.jar
LIBXANAME = xmlacl.jar
LIBSAX2 = $(LIBDIR)/sax2/sax2.jar
MAKE = gmake

JC = javac

JFLAGS = -deprecation -O -sourcepath $(SRCDIR) -d $(CLSDIR)

BATCH_XA=$(ROOTDIR)/make.bat
BATCH_XALIB=$(ROOTDIR)/makelib.bat
BATCH_XACLEAN=$(ROOTDIR)/makeclean.bat
BATCH_XACLDIST=$(ROOTDIR)/makedist.bat

export ROOTDIR
export CLSDIR
export JADECLSDIR
export LIBJADE
export LIBBASE64
export LIBSAX2

# The following targets are not file names
.PHONY: all lib clean batch

XAROOT = 	jamr/jadeacl/xml/XMLACLCodec.java 

all: 
	@echo Building XML-ACL sources
	cd $(SRCDIR) ; \
	$(JC) -classpath $(JADECLSDIR):$(LIBJADE):$(LIBBASE64):$(LIBSAX2) $(JFLAGS) $(XAROOT) ; \
	cd $(ROOTDIR)
	@echo XML-ACL sources built

lib:
	@echo Building XML-ACL libraries
	cd $(CLSDIR); \
	rm -f $(LIBDIR)/$(LIBXANAME) ; \
	$(AR) $(ARFLAGS) $(LIBDIR)/$(LIBXANAME) jamr ; \
	rm -rf jamr ; \
	cd $(ROOTDIR)
	@echo XML-ACL libraries built

clean:
	@echo Cleaning up XML-ACL 
	rm -f `find . -name '*~'`
	rm -f `find . -name '#*#'`
	rm -fr $(CLSDIR)/jamr 
	rm -f $(LIBDIR)/$(LIBXANAME)
	@echo XML-ACL cleaned up

batch: 	
	rm -f $(BATCH_XA)
	echo '@REM ===============================================================' > $(BATCH_XA)
	echo '@REM =           Generated by JADE Makefile. DO NOT EDIT           =' >> $(BATCH_XA)
	echo '@REM ===============================================================' >> $(BATCH_XA)
	echo >> $(BATCH_XA)
	echo 'cd src' >> $(BATCH_XA)
	echo >> $(BATCH_XA)
	echo '$(JC) -classpath $(subst /,\,$(subst $(ROOTDIR),..,$(LIBJADE);$(LIBBASE64);$(LIBSAX2);$(JADECLSDIR))) $(subst /,\,$(subst $(ROOTDIR),..,$(JFLAGS))) $(subst /,\,$(XAROOT))' >> $(BATCH_XA)
	echo >> $(BATCH_XA)
	echo 'cd ..' >> $(BATCH_XA)
	echo '@REM ===============================================================' > $(BATCH_XALIB)
	echo '@REM =           Generated by JADE Makefile. DO NOT EDIT           =' >> $(BATCH_XALIB)
	echo '@REM ===============================================================' >> $(BATCH_XALIB)
	echo >> $(BATCH_XALIB)
	echo 'cd $(subst /,\,$(subst $(ROOTDIR),.,$(CLSDIR)))' >> $(BATCH_XALIB)
	echo >> $(BATCH_XALIB)
	echo 'rmdir /S /Q $(subst /,\,$(subst $(ROOTDIR),..,$(LIBDIR)))\$(LIBXANAME)' >> $(BATCH_XALIB) # For Win NT 4
	echo 'deltree /Y $(subst /,\,$(subst $(ROOTDIR),..,$(LIBDIR)))\$(LIBXANAME)' >> $(BATCH_XALIB)  # For Win 95/98
	echo >> $(BATCH_XALIB)
	echo '$(AR) $(ARFLAGS) $(subst /,\,$(subst $(ROOTDIR),..,$(LIBDIR)))\$(LIBXANAME) jamr' >> $(BATCH_XALIB)
	echo 'rmdir /S /Q jamr' >> $(BATCH_XALIB) # For Win NT 4
	echo 'deltree /Y jamr' >> $(BATCH_XALIB)  # For Win 95/98
	echo >> $(BATCH_XALIB)
	echo 'cd ..' >> $(BATCH_XALIB)
	rm -f $(BATCH_XACLEAN)
	echo '@REM ===============================================================' > $(BATCH_XACLEAN)
	echo '@REM =           Generated by JADE Makefile. DO NOT EDIT           =' >> $(BATCH_XACLEAN)
	echo '@REM ===============================================================' >> $(BATCH_XACLEAN)
	echo >> $(BATCH_XACLEAN)
	echo 'rmdir /S /Q $(subst /,\,$(subst $(ROOTDIR),.,$(CLSDIR)))\jamr' >> $(BATCH_XACLEAN) # For Win NT 4
	echo 'deltree /Y $(subst /,\,$(subst $(ROOTDIR),.,$(CLSDIR)))\jamr' >> $(BATCH_XACLEAN) # For Win 95/98
	echo 'del $(subst /,\,$(subst $(ROOTDIR),.,$(LIBDIR)))\$(LIBXANAME)' >> $(BATCH_XACLEAN)
	echo '@REM ===============================================================' > $(BATCH_XACLDIST)
	echo '@REM =           Generated by JADE Makefile. DO NOT EDIT           =' >> $(BATCH_XACLDIST)
	echo '@REM ===============================================================' >> $(BATCH_XACLDIST)
	echo >> $(BATCH_XACLDIST)
	echo >> $(BATCH_XACLDIST) 
	echo 'call $(subst /,\,$(subst $(ROOTDIR),.,$(BATCH_XA)))' >> $(BATCH_XACLDIST)
	echo 'call $(subst /,\,$(subst $(ROOTDIR),.,$(BATCH_XALIB)))' >> $(BATCH_XACLDIST)
	echo 'cd ..\..' >> $(BATCH_XACLDIST)
	echo '$(ZIP) $(ZIPFLAGS) XMLACLCodecAddOn.$(ZIPEXT) add-ons\xmlacl' >> $(BATCH_XACLDIST)
