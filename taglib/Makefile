# Makefile for JADE tag library project

ZIP = jar
ZIPFLAGS = cMvf
ZIPEXT = zip
AR = jar
ARFLAGS = cf

ROOTDIR = $(shell pwd)
ROOTNAME = $(shell basename $(ROOTDIR))
DOCDIR  = $(ROOTDIR)/../doc
SRCDIR  = $(ROOTDIR)/src
CLSDIR  = $(ROOTDIR)/web/WEB-INF/classes
LIBDIR  = $(ROOTDIR)/web/WEB-INF/lib
JADESRCDIR=$(ROOTDIR)/../src
JADECLSDIR  = $(ROOTDIR)/../../classes
JADELIBDIR  = $(ROOTDIR)/../../lib
LIBJADE = $(JADELIBDIR)/jade.jar
LIBTAGLIBNAME = jadetaglib.jar
LIBSERVLET=$(JADELIBDIR)/servlet.jar
EXAMPLELIBNAME = jspagents.jar 
MAKE = make

JC = javac

JFLAGS = -deprecation -O -sourcepath $(SRCDIR) -d $(CLSDIR)

BATCH_TAGLIB=$(ROOTDIR)/make.bat
BATCH_TAGLIBLIB=$(ROOTDIR)/makelib.bat
BATCH_TAGLIBCLEAN=$(ROOTDIR)/makeclean.bat
BATCH_TAGLIBDIST =$(ROOTDIR)/makedist.bat
BATCH_TAGLIBEXAMPLE =$(ROOTDIR)/makeexample.bat

export ROOTDIR
export CLSDIR
export JADECLSDIR
export LIBJADE

# The following targets are not file names
.PHONY: all lib clean batch example

TAGLIBROOT = 	jade/wrapper/taglib/ContainerTag.java \
                jade/wrapper/taglib/SendObjectTag.java \
                jade/wrapper/taglib/UseAgentTag.java \
                jade/wrapper/taglib/UseAgentTEI.java 

all: 
	@echo Building JADE TAGLIB sources
	cd $(SRCDIR) ; \
	$(JC) -classpath $(JADECLSDIR):$(LIBJADE):$(LIBSERVLET) $(JFLAGS) $(TAGLIBROOT) ; \
	cd $(CLSDIR); \
	cd $(ROOTDIR)
	@echo JADE TAGLIB sources built

example:
	@echo Building JADE TAGLIB example
	cd $(SRCDIR) ; \
	$(JC) -classpath $(JADECLSDIR):$(LIBJADE):$(LIBDIR)/$(LIBTAGLIBNAME):$(CLSDIR) $(JFLAGS) examples/jsp/*.java ; \
	cd $(CLSDIR); \
	rm -f $(LIBDIR)/$(EXAMPLELIBNAME) ; \
	$(AR) $(ARFLAGS) $(LIBDIR)/$(EXAMPLELIBNAME) examples ; \
	rm -rf examples ; \
	cd $(ROOTDIR)
	@echo JADE TAGLIB example built

lib:
	@echo Building JADE TAGLIB libraries
	cd $(CLSDIR); \
	rm -f $(LIBDIR)/$(LIBTAGLIBNAME) ; \
	$(AR) $(ARFLAGS) $(LIBDIR)/$(LIBTAGLIBNAME) jade ; \
	rm -rf jade ; \
	cd $(ROOTDIR)
	@echo JADE TAGLIB libraries built

clean:
	@echo Cleaning up JADE TAGLIB
	rm -f `find . -name '*~'`
	rm -f `find . -name '#*#'`
	rm -fr $(CLSDIR)/jade
	rm -f $(LIBDIR)/$(LIBTAGLIBNAME)
	@echo JADE TAGLIB cleaned up

batch: 	
	rm -f $(BATCH_TAGLIB)
	echo '@REM ===============================================================' > $(BATCH_TAGLIB)
	echo '@REM =           Generated by JADE Makefile. DO NOT EDIT           =' >> $(BATCH_TAGLIB)
	echo '@REM ===============================================================' >> $(BATCH_TAGLIB)
	echo >> $(BATCH_TAGLIB)
	echo 'cd src' >> $(BATCH_TAGLIB)
	echo >> $(BATCH_TAGLIB)
	echo '$(JC) -classpath $(subst /,\,$(subst $(ROOTDIR),..,$(LIBJADE);$(JADECLSDIR);$(LIBSERVLET))) $(subst /,\,$(subst $(ROOTDIR),..,$(JFLAGS))) $(subst /,\,$(TAGLIBROOT))' >> $(BATCH_TAGLIB)
	echo >> $(BATCH_TAGLIB)
	echo 'cd ..' >> $(BATCH_TAGLIB)
	echo '@REM ===============================================================' > $(BATCH_TAGLIBLIB)
	echo '@REM =           Generated by JADE Makefile. DO NOT EDIT           =' >> $(BATCH_TAGLIBLIB)
	echo '@REM ===============================================================' >> $(BATCH_TAGLIBLIB)
	echo >> $(BATCH_TAGLIBLIB)
	echo 'call $(subst /,\,$(subst $(ROOTDIR),.,$(BATCH_TAGLIB)))' >> $(BATCH_TAGLIBLIB)
	echo 'cd $(subst /,\,$(subst $(ROOTDIR),.,$(CLSDIR)))' >> $(BATCH_TAGLIBLIB)
	echo >> $(BATCH_TAGLIBLIB)
	echo 'del /S /Q $(subst /,\,$(subst $(ROOTDIR),../../..,$(LIBDIR)))\$(LIBTAGLIBNAME)' >> $(BATCH_TAGLIBLIB) 
	echo >> $(BATCH_TAGLIBLIB)
	echo '$(AR) $(ARFLAGS) $(subst /,\,$(subst $(ROOTDIR),../../..,$(LIBDIR)))\$(LIBTAGLIBNAME) jade' >> $(BATCH_TAGLIBLIB)
	echo 'rmdir /S /Q jade' >> $(BATCH_TAGLIBLIB) # For Win NT 4
	echo 'deltree /Y jade' >> $(BATCH_TAGLIBLIB)  # For Win 95/98
	echo >> $(BATCH_TAGLIBLIB)
	echo 'cd ..\..\..' >> $(BATCH_TAGLIBLIB)
	rm -f $(BATCH_TAGLIBCLEAN)
	echo '@REM ===============================================================' > $(BATCH_TAGLIBCLEAN)
	echo '@REM =           Generated by JADE Makefile. DO NOT EDIT           =' >> $(BATCH_TAGLIBCLEAN)
	echo '@REM ===============================================================' >> $(BATCH_TAGLIBCLEAN)
	echo >> $(BATCH_TAGLIBCLEAN)
	echo 'rmdir /S /Q $(subst /,\,$(subst $(ROOTDIR),.,$(CLSDIR)))\jade' >> $(BATCH_TAGLIBCLEAN) # For Win NT 4
	echo 'deltree /Y $(subst /,\,$(subst $(ROOTDIR),.,$(CLSDIR)))\jade' >> $(BATCH_TAGLIBCLEAN) # For Win 95/98
	echo 'del $(subst /,\,$(subst $(ROOTDIR),.,$(LIBDIR)))\$(LIBTAGLIBNAME)' >> $(BATCH_TAGLIBCLEAN)
	echo '@REM ===============================================================' > $(BATCH_TAGLIBDIST)
	echo '@REM =           Generated by JADE Makefile. DO NOT EDIT           =' >> $(BATCH_TAGLIBDIST)
	echo '@REM ===============================================================' >> $(BATCH_TAGLIBDIST)
	echo >> $(BATCH_TAGLIBDIST)
	echo >> $(BATCH_TAGLIBDIST) 
	echo 'call $(subst /,\,$(subst $(ROOTDIR),.,$(BATCH_TAGLIB)))' >> $(BATCH_TAGLIBDIST)
	echo 'call $(subst /,\,$(subst $(ROOTDIR),.,$(BATCH_TAGLIBLIB)))' >> $(BATCH_TAGLIBDIST)
	echo 'cd ..\..' >> $(BATCH_TAGLIBDIST)
	echo '$(ZIP) $(ZIPFLAGS) taglibAddOn.$(ZIPEXT) add-ons\taglib' >> $(BATCH_TAGLIBDIST)
	echo '@REM ===============================================================' > $(BATCH_TAGLIBEXAMPLE)
	echo '@REM =           Generated by JADE Makefile. DO NOT EDIT           =' >> $(BATCH_TAGLIBEXAMPLE)
	echo '@REM ===============================================================' >> $(BATCH_TAGLIBEXAMPLE)
	echo >> $(BATCH_TAGLIBEXAMPLE)
	echo >> $(BATCH_TAGLIBEXAMPLE) 
	echo 'cd src' >> $(BATCH_TAGLIBEXAMPLE)
	echo '$(JC) -classpath $(subst /,\,$(subst $(ROOTDIR),..,$(LIBJADE);$(JADECLSDIR);$(LIBDIR)/$(LIBTAGNAME);$(CLSDIR))) $(subst /,\,$(subst $(ROOTDIR),..,$(JFLAGS))) examples\jsp\*.java' >> $(BATCH_TAGLIBEXAMPLE)
	echo >> $(BATCH_TAGLIBEXAMPLE)
	echo 'cd $(subst /,\,$(subst $(ROOTDIR),..,$(CLSDIR)))' >> $(BATCH_TAGLIBEXAMPLE)
	echo 'del $(subst /,\,$(subst $(ROOTDIR),../../..,$(LIBDIR)))\$(EXAMPLELIBNAME)' >> $(BATCH_TAGLIBEXAMPLE)
	echo '$(AR) $(ARFLAGS) $(subst /,\,$(subst $(ROOTDIR),../../..,$(LIBDIR)))\$(EXAMPLELIBNAME) examples' >> $(BATCH_TAGLIBEXAMPLE)
	echo 'rmdir /S /Q examples' >> $(BATCH_TAGLIBEXAMPLE) # For Win NT 4
	echo 'deltree /Y examples' >> $(BATCH_TAGLIBEXAMPLE)  # For Win 95/98
	echo >> $(BATCH_TAGLIBEXAMPLE)
	echo 'cd ..\..\..' >> $(BATCH_TAGLIBEXAMPLE)

